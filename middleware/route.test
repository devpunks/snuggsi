const
  { test, fetch, read }
    = require ('test')

, { route }
    = require ('.')

, { Server }
    = require ('..')

, uri  = '/foo/'
, body = 'Shazam'

, middleware
    = (context) =>
        (context.body = body)


test ('route URI to middleware', async t => {

  const
    stack
      = [ route (uri, middleware) ]

  , server
      = (new Server (stack))
      .serve ``

  , response
      = await fetch (`http://localhost:8181${uri}`)

  , status = response.status


  t.equal (200, status)

  t.equal (body, await read (response.body))

  server.close ``
  t.end ()
})


test ('route URI with {token} to middleware', async t => {

  const
    token = '{timestamp}'
  , path  = `${uri}${token}`
  , timestamp = (new Date)
      .getTime `` + ''

  , echo = context =>
      t.equal (timestamp, context.params.timestamp)

  , stack =
      [ route (path, echo) ]

 ,  server
      = (new Server (stack))
      .serve ``

  , response
      = await fetch (`http://localhost:8181${uri}${timestamp}`)

  , status = response.status

  server.close ``
  t.end ()
})


test ('URI without route', async t => {

  const
    stack
      = [ route (uri, middleware) ]

  , server
      = (new Server (stack))
      .serve ``

  , response
      = await fetch ('http://localhost:8181/adsfadsf/')

  , status = response.status


  t.equal (404, status)

  server.close ``
  t.end ()
})
