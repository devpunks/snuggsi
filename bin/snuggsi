#!/usr/bin/env bash

# Environment variable vs. Shell Variable
#  - https://askubuntu.com/questions/26318/environment-variable-vs-shell-variable-whats-the-difference

# Shell Parameter Expansion
#  - https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html

# Bash string manipulations
#  - http://www.tldp.org/LDP/LG/issue18/bash.html
#  - https://stackoverflow.com/questions/6393551/what-is-the-meaning-of-0-in-a-bash-script

echo "
  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„
  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„                  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„
  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„    snuggsi ãƒ„    ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„
  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„                  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„
  ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„ãƒ„
"

function node_path { # npm bin -g
  local \
    node=`npm config get prefix | awk NR==1` \
    modules=lib/node_modules

  echo ${NODE_PATH:-$node/$modules}
}

function run {
  source $SNUGGSI/bin/.arguments

  local \
    executable=$1

  test ! -f $executable \
    || test ${executable##*/} == snuggsi \
    && echo "ğŸ”´  Invalid command \`${executable##*/}\`" \
    && ${executable%\/*}/help \
    && exit 1


  echo "ğŸ“š  MOUNTING RESOURCES â€¦"
  printf '    ğŸ“  %s\n' "${resources[@]}"
  echo

  for resource in "${ARGUMENTS[@]:-. }" # Default o curren directory
    do
      if test -d $resource
        then
          echo " ğŸ‘‰  ğŸ“‚  $resource â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          $executable $resource
        else
          echo "ğŸ”´  $resource RESOURCE DIRECTORY NOT FOUND !"
      fi
    done
}

declare -rx \
  NODE_PATH=`node_path` \
  SNUGGSI=`node_path`/${BASH_SOURCE##*/} # TODO: benchmark as node_path is rather slow due to npm


run $SNUGGSI/bin/${@:-help}
