const
  path = '/foo/'
, URL  = `http://localhost:8181${path}`

, { test, read, fetch }
    = require ('test')

, { Server, Resource }
    = require ('..')

, route = resource =>
    require ('../middleware')
    .route  ( `${path}{id}`, resource )

, DEFAULT_METHODS = [ 'GET', 'HEAD'  ]

, METHODS = [ ... require ('http').METHODS ]
    // for some reason connect won't work
    .filter (method => method !== 'CONNECT')

, SAFE_METHODS = ['OPTIONS', ... DEFAULT_METHODS ]

, UNSAFE_METHODS = METHODS.filter
    (method => !!! SAFE_METHODS.includes (method))

, unique = (method, index, methods) =>
    methods.indexOf (method) === index


test ('Default Resource allowed methods', async t => {
  const
    resource = Resource ``

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``

  for (method of SAFE_METHODS) {
    let { status, headers }
      = await fetch ( `${URL}14`, { method } )

    t.notOk ('allow' in headers)
    t.ok ( [200,204].includes (status) )
  }

  server.close ``
  t.end ()
})


test.only ('Default Resource disallowed methods', async t => {
  const
    resource = Resource ``

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``


  for (method of UNSAFE_METHODS) {

    let { status, headers }
      = await fetch ( `${URL}14`, { method } )

    t.equals ( DEFAULT_METHODS.join `, `, headers.get ('allow') )
    t.equals ( 405, status )
  }

  server.close ``
  t.end ()
})


test ('Defined Resource allowed methods', async t => {
  const
    { __proto__: proto } = resource
      = Resource `server/fixtures`

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``

  , DEFINED_METHODS = Object
      .getOwnPropertyNames (Object.getPrototypeOf (proto))
      .filter (method => !!! (method === 'constructor'))
      .map (method => method.toUpperCase ())


  for (method of DEFINED_METHODS) {
    let
      { status, headers } = await fetch ( `${URL}14`, { method } )

    t.notEqual ( 405, status )
    t.notOk (headers.get ('allow') )
  }

  server.close ``
  t.end ()
})


test ('Defined Resource disallowed methods', async t => {
  const
    { __proto__: proto } = resource
      = Resource `server/fixtures`

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``

  , DEFINED_METHODS = Object
      .getOwnPropertyNames (Object.getPrototypeOf (proto))
      .map (method => method.toUpperCase ())

  , ALLOWED_METHODS
      = [ ... DEFAULT_METHODS, ... DEFINED_METHODS ]
        .filter (method => METHODS.includes (method))
        .filter (unique)

  , DISALLOWED_METHODS = METHODS
      .filter (method => method !== 'OPTIONS') // cors?
      .filter (name => !!! ALLOWED_METHODS.includes (name))


  for (method of DISALLOWED_METHODS) {

    let
      { status, headers } = await fetch ( `${URL}14`, { method } )
    , methods = headers.get ('allow').split `, `
    , included = method => methods.includes (method)
    , check = allowed => allowed.every (included)

    t.equal ( 405, status )
    t.ok ( check (ALLOWED_METHODS) )
  }

  server.close ``
  t.end ()
})
