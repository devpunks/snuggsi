const
  path = '/foo/'
, URL  = `http://localhost:8181${path}`

, { test, read, fetch }
    = require ('test')

, { Server, Resource }
    = require ('..')

, route = resource =>
    require ('../middleware')
    .route  ( `${path}{id}`, resource )

, DEFAULT_METHODS = [ 'GET', 'HEAD'  ]

, METHODS = [ ... require ('http').METHODS ]

, SAFE_METHODS = ['OPTIONS', ... DEFAULT_METHODS ]

, UNSAFE_METHODS = METHODS.filter
    (method => !!! SAFE_METHODS.includes (method))


test ('Default Resource allowed methods', async t => {
  const
    resource = Resource ``

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``

  for (method of SAFE_METHODS) {
    let { status, headers }
      = await fetch ( `${URL}14`, { method } )

    t.notOk ('allow' in headers)
    t.ok ( [200,204].includes (status) )
  }

  server.close ``
  t.end ()
})


test ('Default Resource disallowed methods', async t => {
  const
    resource = Resource ``

  , server =
      (new Server ( [ route (resource) ] ))
      .serve ``


  for (method of UNSAFE_METHODS.filter (message => message !== 'CONNECT')) {

    let { status, headers }
      = await fetch ( `${URL}14`, { method } )

    t.equals ( DEFAULT_METHODS.join `, `, headers.get ('allow') )
    t.equals ( 405, status )
  }

  server.close ``
  t.end ()
})


test ('Allowed methods', async t => {
  const
    server =
      (new Server ( [ route ] ))
      .serve ``

  for (method of SAFE_METHODS) {
    let { status, headers }
      = await fetch ( `${URL}14`, { method } )

    t.notOk ('allowed' in headers)
    t.ok ( [200,204].includes (status) )
  }

  server.close ``
  t.end ()
})


test ('new Resource', async t => {

  const
    method = 'TRACE'

  , endpoint
      = [ `${URL}14`, { method } ]

  , server =
      (new Server ( [ route ] ))
      .serve ``

  , response =
      await fetch ( ... endpoint )

  , { status, body } = response

  console.warn ('Resp', status, response.headers,  await response.text (), NONSAFE_METHODS, SAFE_METHODS)


  server.close ``
  t.end ()
})
